name: Quarkç­¾åˆ°

on:
  schedule:
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00 (UTC+8 -> UTC+1)
    - cron: '0 5 * * *'   # åŒ—äº¬æ—¶é—´ 13:00 (UTC+8 -> UTC+5)
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-if-already-signed:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      current_date: ${{ steps.get-date.outputs.current_date }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è·å–å½“å‰æ—¥æœŸ
        id: get-date
        run: |
          current_date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "current_date=$current_date" >> "$GITHUB_OUTPUT"
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $current_date"

      - name: æ¢å¤ç­¾åˆ°æˆåŠŸè®°å½•ç¼“å­˜
        id: cache-success-restore
        uses: actions/cache@v4
        with:
          path: .last_success_date
          key: last-success-date-${{ steps.get-date.outputs.current_date }}
          restore-keys: last-success-date-${{ steps.get-date.outputs.current_date }}

      - name: åˆ¤æ–­æ˜¯å¦å·²ç­¾åˆ°
        id: check
        run: |
          current_date="${{ steps.get-date.outputs.current_date }}"
          echo "æ£€æŸ¥æ—¥æœŸ: $current_date"
          
          if [ -f .last_success_date ]; then
            last_date=$(cat .last_success_date)
            echo "ä»ç¼“å­˜æ¢å¤çš„æ—¥æœŸ: $last_date"
            
            if [[ "$last_date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              if [ "$last_date" = "$current_date" ]; then
                echo "ä»Šå¤©å·²æˆåŠŸç­¾åˆ°ï¼Œè·³è¿‡æ‰§è¡Œã€‚"
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              else
                echo "ç¼“å­˜æ—¥æœŸä¸ä»Šå¤©ä¸ç¬¦ï¼Œéœ€è¦é‡æ–°ç­¾åˆ°"
                echo "ç¼“å­˜æ—¥æœŸ: $last_date"
                echo "ä»Šå¤©æ—¥æœŸ: $current_date"
              fi
            else
              echo "âŒ ç¼“å­˜æ–‡ä»¶å†…å®¹æ— æ•ˆ: '$last_date'ï¼Œåˆ é™¤æ— æ•ˆæ–‡ä»¶"
              rm -f .last_success_date
            fi
          else
            echo "ğŸ“ æœªæ‰¾åˆ°ç¼“å­˜æ–‡ä»¶ï¼Œéœ€è¦ç­¾åˆ°"
          fi

          echo "ğŸš€ ä»Šå¤©å°šæœªç­¾åˆ°ï¼Œç»§ç»­æ‰§è¡Œã€‚"
          echo "skip=false" >> "$GITHUB_OUTPUT"

  sign-in:
    needs: check-if-already-signed
    if: needs.check-if-already-signed.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: éšæœºå»¶è¿Ÿï¼ˆæ—©ä¸Šï¼‰
        if: github.event.schedule == '0 1 * * *'
        run: |
          delay=$((RANDOM % 60))
          echo "æ—©ä¸Šç­¾åˆ°ï¼Œå»¶è¿Ÿ $delay ç§’åå¼€å§‹.."
          sleep $delay

      - name: éšæœºå»¶è¿Ÿï¼ˆä¸‹åˆ/æ‰‹åŠ¨è§¦å‘ï¼‰
        if: github.event.schedule == '0 5 * * *' || github.event_name == 'workflow_dispatch'
        run: |
          delay=$((RANDOM % 30))
          echo "ä¸‹åˆå…œåº•æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œå»¶è¿Ÿ $delay ç§’åå¼€å§‹.."
          sleep $delay

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests

      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        env:
          COOKIE_QUARK: ${{ secrets.COOKIE_QUARK }}
          TG_CONFIG: ${{ secrets.TG_CONFIG }}
        run: python checkIn_Quark.py

      - name: æ ‡è®°ä»Šå¤©ç­¾åˆ°æˆåŠŸ
        if: success()
        run: |
          date_str="${{ needs.check-if-already-signed.outputs.current_date }}"
          echo "å†™å…¥ç­¾åˆ°æ—¥æœŸ: $date_str"
          echo "$date_str" > .last_success_date
          echo "éªŒè¯å†™å…¥å†…å®¹: $(cat .last_success_date)"

      - name: ä¿å­˜æˆåŠŸè®°å½•åˆ°ç¼“å­˜ï¼ˆè¦†ç›–æ—§ç¼“å­˜ï¼‰
        if: success()
        uses: actions/cache@v4
        with:
          path: .last_success_date
          key: last-success-date-${{ needs.check-if-already-signed.outputs.current_date }}

  already-signed:
    needs: check-if-already-signed
    if: needs.check-if-already-signed.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests

      - name: æ‰§è¡Œè·³è¿‡é€šçŸ¥è„šæœ¬
        env:
          TG_CONFIG: ${{ secrets.TG_CONFIG }}
        run: python iskip.py

  final:
    needs: [check-if-already-signed, sign-in, already-signed]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: æ¸…ç†æ—§çš„å·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0 # ä¿ç•™çš„å¤©æ•°
          keep_minimum_runs: 30 # è¦ä¿ç•™çš„æœ€å°å·¥ä½œæµæ•°

      # - name: æ£€å‡ºä»£ç 
      #   uses: actions/checkout@v3

      # - name: è®¾ç½®Pythonç¯å¢ƒ
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: '3.x'

      # - name: å®‰è£…ä¾èµ–
      #   run: pip install requests

      # - name: è¿è¡Œç¼“å­˜æ¸…ç†è„šæœ¬
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     GITHUB_REPOSITORY: ${{ github.repository }}
      #     RETENTION_DAYS: 7      # ä½ å¯è°ƒæ•´ N å¤©
      #   run: |
      #     python clean_caches.py
